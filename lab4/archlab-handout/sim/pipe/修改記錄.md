
## version 1

將條件控制轉移改爲條件數據傳送

``` assembly
	xorq %rax,%rax		# count = 0;
	jmp Test
Loop:
	mrmovq (%rdi), %r10
	rmmovq %r10, (%rsi)
	irmovq $1, %r11
	subq %r11, %rdx
	addq %rax, %r11
	andq %r10, %r10
	cmovg %r11, %rax
	irmovq $8, %r10
	addq %r10, %rdi
	addq %r10, %rsi
Test:
	andq %rdx, %rdx
	jg Loop			# if so, goto Loop:
```

## version 2

將 load/use 冒險去除

``` assembly
	xorq %rax,%rax		# count = 0;
	jmp Test
Loop:
	mrmovq (%rdi), %r10
	irmovq $1, %r11
	subq %r11, %rdx
	addq %rax, %r11
	andq %r10, %r10
	cmovg %r11, %rax
	rmmovq %r10, (%rsi)   # 這樣就沒有冒險了
	irmovq $8, %r10
	addq %r10, %rdi
	addq %r10, %rsi
Test:
	andq %rdx, %rdx
	jg Loop			# if so, goto Loop:
```

## version 3

使用 loop unrolling 進行展開，

``` assembly
	xorq %rax,%rax		# count = 0;
	rrmovq %rdx, %rbx
	irmovq $0x1, %r9    # const 1
	irmovq $0x4, %r13   # const 2, stride
	irmovq $0x3, %r14   # const 1, stride - 1
	subq %r14, %rbx     # limit = len - stride + 1
	irmovq $0x8, %r12   # const 8
	jmp Test
Loop:
	mrmovq (%rdi), %r10
	rrmovq %rax, %r11
	addq %r9, %r11
	rmmovq %r10, (%rsi)
	andq %r10, %r10
	cmovg %r11, %rax
	addq %r12, %rdi
	addq %r12, %rsi
	
	mrmovq (%rdi), %r10
	rrmovq %rax, %r11
	addq %r9, %r11
	rmmovq %r10, (%rsi)
	andq %r10, %r10
	cmovg %r11, %rax
	addq %r12, %rdi
	addq %r12, %rsi

	mrmovq (%rdi), %r10
	rrmovq %rax, %r11
	addq %r9, %r11
	rmmovq %r10, (%rsi)
	andq %r10, %r10
	cmovg %r11, %rax
	addq %r12, %rdi
	addq %r12, %rsi
	
	mrmovq (%rdi), %r10
	rrmovq %rax, %r11
	addq %r9, %r11
	rmmovq %r10, (%rsi)
	andq %r10, %r10
	cmovg %r11, %rax
	addq %r12, %rdi
	addq %r12, %rsi
	
	
	subq %r13, %rbx
Test:
	andq %rbx, %rbx
	jg Loop			# if so, goto Loop:

	addq %rbx, %r14
	andq %r14, %r14
	je Done
Last:
	mrmovq (%rdi), %r10
	rrmovq %rax, %r11
	addq %r9, %r11
	rmmovq %r10, (%rsi)
	andq %r10, %r10
	cmovg %r11, %rax
	addq %r12, %rdi
	addq %r12, %rsi
	subq %r9, %r14
	andq %r14, %r14
	jg Last
```

